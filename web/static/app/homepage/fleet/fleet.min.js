"use strict";angular.module("homepage.fleets",["utils","ui.bootstrap","ui.grid","ui.grid.selection","ui.grid.resizeColumns","ui.grid.moveColumns","ui.grid.treeView","ui.grid.edit"]).config(function(){}),angular.module("homepage.fleets").factory("fleetService",["restResource","config",function(e,i){var t=e.$resource,n=e.endpoint("fleet");return{id:t(n+":id/",{id:"@id",limit:i.get("fleet_page_limit")},{update:{method:"PUT"}}),user:t(n+":id/user/:email/",{id:"@id",email:"@email",limit:i.get("user_page_limit")}),device:t(n+":id/device/:email/",{id:"@id",email:"@email",limit:i.get("device_page_limit")}),q:t(n,{name:"@name"},{get:{method:"GET"}})}}]),angular.module("homepage.fleets").controller("fleetController",["$scope","config","messagingService","deviceService","userService","fleetService","$uibModal",function(e,i,t,n,l,o,r){var a=this;a.device_grid={enableCellEdit:!0,enableRowSelection:!0,multiSelect:!1,enableGridMenu:!0,enableSorting:!1,enableFiltering:!1,enableRowHeaderSelection:!1,columnDefs:[{name:"Serial",field:"serial",enableCellEdit:!1},{name:"Description",field:"description"},{name:"Plate",field:"plate"},{name:"VIN",field:"vin"},{name:"Type",field:"type",enableCellEdit:!1},{name:"Active",field:"is_active",width:60,enableCellEdit:!1},{name:"Show Journeys",displayName:"",width:40,enableColumnMenu:!1,enableFiltering:!1,cellTemplate:"show_journey_button.html"}],onRegisterApi:function(i){a.device_grid.gridApi=i,i.selection.on.rowSelectionChanged(e,function(e){t.pub(t.DEFAULT_DOMAIN,"device_selected",e.entity)}),i.edit.on.afterCellEdit(e,function(e,i,t,l){t!==l&&n.id.update(e).$promise["catch"](function(t){e[i.field]=l})})}},a.user_grid={enableCellEdit:!0,enableRowSelection:!0,multiSelect:!1,enableGridMenu:!0,enableSorting:!1,enableFiltering:!1,enableRowHeaderSelection:!1,columnDefs:[{name:"Name",field:"name"},{name:"Email",field:"email",enableCellEdit:!1},{name:"Last Login",field:"last_login",enableCellEdit:!1},{name:"Active",field:"is_active",width:60,enableCellEdit:!1}],onRegisterApi:function(i){a.user_grid.gridApi=i,i.selection.on.rowSelectionChanged(e,function(e){var i=e.entity.email;l.getUserDetail(i,function(e){for(var i=e.fleets,l=[],o=0;o<i.length;o++)l.push(i[o].id);n.getDevicesForFleet(l,function(e){a._makeUniqueDevices(e.objects),a.device_grid.data=e.objects,t.pub(t.DEFAULT_DOMAIN,"devices",e.objects)})})}),i.edit.on.afterCellEdit(e,function(e,i,t,n){t!==n&&l.id.update(e).$promise["catch"](function(t){e[i.field]=n})})}},a._makeUniqueDevices=function(e){for(var i="",t=e.length-1;t>-1;t--)e[t].email===i?e.splice(t,1):i=e[t].email},a.fleet_grid={enableCellEdit:!0,enableRowSelection:!0,enableGridMenu:!1,multiSelect:!1,enableSorting:!1,enableFiltering:!1,enableRowHeaderSelection:!1,showTreeExpandNoChildren:!0,columnDefs:[{name:"Fleet",field:"label",enableColumnMenu:!1}],onRegisterApi:function(i){a.fleet_grid.gridApi=i,i.selection.on.rowSelectionChanged(e,function(e){var i=e.entity;n.getDevicesForFleet(i.id,function(e){a.device_grid.data=e.objects,t.pub(t.DEFAULT_DOMAIN,"devices",e.objects)}),l.getUsersForFleet(i.id,function(e){a.user_grid.data=e.objects})}),i.edit.on.afterCellEdit(e,function(e,i,t,n){t!==n&&o.id.update(e).$promise["catch"](function(t){e[i.field]=n})})}},t.sub(e,t.DEFAULT_DOMAIN,"user",function(e,i){var t=[];a._flattenTree(i.fleets,t,0),a.fleet_grid.data=t,"FLEET_ADMIN"===i.role&&(a.device_grid.enableCellEdit=!0,a.fleet_grid.enableCellEdit=!0,a.fleet_grid.columnDefs.push({name:"Add/Remove",width:40,enableColumnMenu:!1,enableFiltering:!1,headerCellTemplate:"fleet_add_button.html",cellTemplate:"fleet_remove_button.html"}),a.user_grid.columnDefs.push({name:"Add/Remove",width:40,enableColumnMenu:!1,enableFiltering:!1,headerCellTemplate:"user_add_button.html",cellTemplate:"user_remove_button.html"}),a.device_grid.columnDefs.push({name:"AddRemove",width:40,enableColumnMenu:!1,enableFiltering:!1,headerCellTemplate:"device_add_button.html",cellTemplate:"device_remove_button.html"}))}),t.sub(e,t.DEFAULT_DOMAIN,"logout",function(e,i){a.fleet_grid.data=[],a.user_grid.data=[],a.device_grid.data=[]}),t.sub(e,t.DEFAULT_DOMAIN,"TOOGLE_MANAGER",function(e,i){a.isManagerVisible=i}),a.isManagerVisible=!0,a._flattenTree=function(e,i,t){for(var n=0;n<e.length;n++)i.push({id:e[n].id,label:e[n].label,$$treeLevel:t}),a._flattenTree(e[n].children,i,t+1)},a._getRootTree=function(e,i){for(var t=0;t<e.length;t++)if(i.$$hashKey===e[t].$$hashKey)for(var n=t;n>-1;n--)if(0===e[n].$$treeLevel)return e[n]},e.showJourney=function(n){var l={id:"journey_"+n.serial,name:"Journeys for "+n.serial,active:!0,include:i.get("static_url")+"app/homepage/journey/journey.html"};t.pub(t.DEFAULT_DOMAIN,"TAB_ADD",l),t.pub(t.DEFAULT_DOMAIN,"TAB_SELECT",l),t.sub(e,l.id,"OPTIONS_ON_LOAD",function(e,i){i.devices.readonly=!0,i.devices.selected=n,t.pub(l.id,"OPTIONS_SUBMITTED",i)})},e.addFleet=function(e){r.open({size:"sm",animation:!0,templateUrl:"add_fleet.html",controller:["$scope","$uibModalInstance",function(i,t){i.fleet=e,i.new_fleet={readonly:!1,name:void 0},i.error={text:void 0,show:!1},i.ok=function(){i.error.show=!1,o.id.save({name:i.new_fleet.name,parent:e.id},function(i){a.fleet_grid.data.forEach(function(t,n,l){return t.id===e.id?(i.$$treeLevel=e.$$treeLevel+1,l.splice(n+1,0,i),!1):void 0}),t.dismiss("cancel")}).$promise["catch"](function(e){i.error.text=e.statusText,i.error.show=!0})},i.cancel=function(){t.dismiss("cancel")}}]})},e.removeFleet=function(e){r.open({size:"sm",animation:!0,templateUrl:"remove_fleet.html",controller:["$scope","$uibModalInstance",function(i,t){i.fleet=e,i.error={text:void 0,show:!1},i.ok=function(){i.error.show=!1,o.id.remove(e,function(i){a.fleet_grid.data.forEach(function(i,t,n){return i.id===e.id?(n.splice(t,1),!1):void 0}),a.user_grid.data=[],a.device_grid.data=[],t.dismiss("cancel")}).$promise["catch"](function(e){i.error.text=e.statusText,i.error.show=!0})},i.cancel=function(){t.dismiss("cancel")}}]})},e.addUserToFleet=function(){r.open({size:"sm",animation:!0,templateUrl:"add_user.html",controller:["$scope","$uibModalInstance",function(e,i){e.fleet=a.fleet_grid.gridApi.selection.getSelectedRows()[0],e.users={readonly:!0,selected:void 0,list:[]},e.error={text:void 0,show:!1};var t=a._getRootTree(a.fleet_grid.data,e.fleet);l.getUsersForFleet(t.id,function(i){e.users.list=i.objects,e.users.readonly=!1}),e.ok=function(){e.error.show=!1,o.user.save({id:e.fleet.id,email:e.users.selected.email},function(t){a.user_grid.data.push(e.users.selected),i.dismiss("cancel")}).$promise["catch"](function(i){e.error.text=i.statusText,e.error.show=!0})},e.cancel=function(){i.dismiss("cancel")}}]})},e.removeUserFromFleet=function(e){r.open({size:"sm",animation:!0,templateUrl:"remove_user.html",controller:["$scope","$uibModalInstance",function(i,t){i.user=e,i.fleet=a.fleet_grid.gridApi.selection.getSelectedRows()[0],i.error={text:void 0,show:!1},i.ok=function(){i.error.show=!1,o.user.remove({id:i.fleet.id,email:e.email},function(i){a.user_grid.data.forEach(function(i,t,n){return i.email===e.email?(n.splice(t,1),!1):void 0}),t.dismiss("cancel")}).$promise["catch"](function(e){i.error.text=e.statusText,i.error.show=!0})},i.cancel=function(){t.dismiss("cancel")}}]})},e.addDeviceToFleet=function(){r.open({size:"sm",animation:!0,templateUrl:"add_device.html",controller:["$scope","$uibModalInstance",function(e,i){e.fleet=a.fleet_grid.gridApi.selection.getSelectedRows()[0],e.devices={readonly:!0,selected:void 0,list:[]},e.error={text:void 0,show:!1};var t=a._getRootTree(a.fleet_grid.data,e.fleet);n.getDevicesForFleet(t.id,function(i){e.devices.list=i.objects,e.devices.readonly=!1}),e.ok=function(){e.error.show=!1,o.device.save({id:e.fleet.id,email:e.devices.selected.email},function(t){a.device_grid.data.push(e.devices.selected),i.dismiss("cancel")}).$promise["catch"](function(i){e.error.text=i.statusText,e.error.show=!0})},e.cancel=function(){i.dismiss("cancel")}}]})},e.removeDeviceFromFleet=function(e){r.open({size:"sm",animation:!0,templateUrl:"remove_device.html",controller:["$scope","$uibModalInstance",function(i,t){i.device=e,i.fleet=a.fleet_grid.gridApi.selection.getSelectedRows()[0],i.error={text:void 0,show:!1},i.ok=function(){i.error.show=!1,o.device.remove({id:i.fleet.id,email:e.email},function(i){a.device_grid.data.forEach(function(i,t,n){return i.email===e.email?(n.splice(t,1),!1):void 0}),t.dismiss("cancel")}).$promise["catch"](function(e){i.error.text=e.statusText,i.error.show=!0})},i.cancel=function(){t.dismiss("cancel")}}]})},e.isNotSelectedRootFleet=function(){var e=a.fleet_grid.gridApi.selection.getSelectedRows();return e.length>0?0!==e[0].$$treeLevel:!0}}]);