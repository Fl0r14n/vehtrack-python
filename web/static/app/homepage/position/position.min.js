"use strict";angular.module("homepage.positions",["utils","widget.options","widget.map"]).config(function(){}),angular.module("homepage.positions").factory("positionService",["restResource","config",function(e,t){var i=e.$resource,o=e.endpoint("position");return{id:i(o+":id/",{id:"@id"}),q:i(o,{limit:"@limit",offset:"@offset",device__serial:"@device_serial",journey__id:"@journey_id",timestamp__gte:"@start_timestamp",timestamp__lte:"@stop_timestamp"},{get:{method:"GET"}}),getPositionsforJourney:function(e,i){this.q.get({journey__id:e,limit:t.get("position_page_limit")},function(e){i&&i(e)})},getPositionsForDevice:function(e,i,o,s){this.q.get({device__serial:e,timestamp__gte:i,timestamp__lte:o,limit:t.get("position_page_limit")},function(e){s&&s(e)})}}}]),angular.module("homepage.positions").controller("positionController",["$scope","config","messagingService","journeyService","positionService",function(e,t,i,o,s){var n=this;n.options_url=t.get("static_url")+"app/widget/options/options.html",n.map_url=t.get("static_url")+"app/widget/map/map.html",n.gmap_icons_url="http://maps.google.com/mapfiles/kml/paddle/",e.domain=e.tabId,i.sub(e,e.domain,"OPTIONS_ON_LOAD",function(e,t){t.devices.show=!0,t.journeys.show=!0,t.startDate.show=!0,t.stopDate.show=!0}),i.sub(e,e.domain,"OPTIONS_SUBMITTED",function(t,a){if(angular.isDefined(a.devices.selected)&&angular.isObject(a.devices.selected))if(o.getJourneysForDevice(a.devices.selected.serial,a.startDate.dateString(),a.stopDate.dateString(),function(e){a.journeys.list=e.objects}),angular.isDefined(a.journeys.selected)&&angular.isObject(a.journeys.selected)){var r=a.journeys.selected;s.getPositionsforJourney(a.journeys.selected.id,function(t){var o=t.objects;if(o.length>0){i.pub(e.domain,"MAP_INIT",{center:{latitude:o[0].latitude,longitude:o[0].longitude}});var s=[{latitude:r.start_latitude,longitude:r.start_longitude,title:r.start_timestamp+"<br/> dst: "+r.distance+"m<br/> dur:"+r.duration+"s",icon:n.gmap_icons_url+"go.png"},{latitude:r.stop_latitude,longitude:r.stop_longitude,title:r.stop_timestamp+"<br/> avg: "+r.average_speed+"km/h<br/> max: "+r.maximum_speed+"km/h",icon:n.gmap_icons_url+"stop.png"}];i.pub(e.domain,"MAP_ADD_MARKERS",s),i.pub(e.domain,"MAP_ADD_POLYLINE",o)}})}else s.getPositionsForDevice(a.devices.selected.serial,a.startDate.dateString(),a.stopDate.dateString(),function(t){var o=t.objects;o.length>0&&(i.pub(e.domain,"MAP_INIT",{center:{latitude:o[0].latitude,longitude:o[0].longitude}}),i.pub(e.domain,"MAP_ADD_POLYLINE",t.objects))})})}]);